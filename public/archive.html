<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Archived Sensor Data</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  --primary:#0ea5e9;
  --secondary:#00ffff;
  --bg:#0c111b;
  --card:rgba(255,255,255,0.05);
  --border:rgba(255,255,255,0.2);
  --hover:rgba(0,255,255,0.1);
  --font:'Segoe UI', Arial;
}

body {
  margin:0;
  font-family:var(--font);
  background:var(--bg);
  color:#fff;
}

.top-bar {
  width:95%;
  margin:20px auto;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.top-bar h2 { color:var(--secondary); }

.top-bar button {
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

.search-bar {
  width:95%;
  margin:10px auto;
  display:flex;
  gap:10px;
  justify-content:flex-end;
}

.search-bar input {
  padding:6px 10px;
  border-radius:6px;
  border:1px solid var(--border);
  background:#020617;
  color:#fff;
}

.search-bar button {
  padding:6px 14px;
  border-radius:6px;
  border:none;
  background:var(--primary);
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}

table {
  width:95%;
  margin:auto;
  border-collapse:separate;
  border-spacing:0;
  background:var(--card);
  border-radius:12px;
  overflow:hidden;
}

th,td {
  padding:8px;
  text-align:center;
  border-bottom:1px solid var(--border);
}

th { background:#001f2f; }
tr:hover { background:var(--hover); }

.hidden { display:none; }
</style>
</head>

<body>

<script>
if(localStorage.getItem('auth')!=='1') location.href='/login.html';
</script>

<div class="top-bar">
  <h2>üì¶ Archive</h2>
  <div>
    <button onclick="exportExcel()">üì• Export Excel</button>
    <button onclick="location.href='admin.html'">‚Üê Back</button>
  </div>
</div>

<div class="search-bar">
  <input id="searchInput" placeholder="Search by patient name">
  <button onclick="searchArchive()">Search</button>
  <button id="toggleBtn" onclick="toggleAll()">Show All</button>
</div>

<table id="archiveTable" class="hidden">
<thead>
<tr>
  <th>ID</th>
  <th>Device</th>
  <th>Patient Name</th>
  <th>Heart Rate</th>
  <th>SpO‚ÇÇ</th>
  <th>Date</th>
  <th>CheckIn</th>
  <th>CheckOut</th>
</tr>
</thead>
<tbody id="archiveRows"></tbody>
</table>

<script>
let showingAll = false;
let currentArchiveData = [];

/* ===== SEARCH ===== */
async function searchArchive(){
  const name = document.getElementById('searchInput').value.trim();
  if(!name) return alert('Enter patient name');
  showingAll = false;
  document.getElementById('toggleBtn').innerText = 'Show All';
  await loadArchive('?search=' + encodeURIComponent(name));
}

/* ===== TOGGLE ALL ===== */
async function toggleAll(){
  const btn = document.getElementById('toggleBtn');
  if(showingAll){
    hideTable();
    btn.innerText = 'Show All';
    showingAll = false;
  } else {
    await loadArchive('');
    btn.innerText = 'Hide All';
    showingAll = true;
  }
}

/* ===== LOAD ARCHIVE ===== */
async function loadArchive(query){
  try {
    const res = await fetch('/api/archiveGet' + query);
    const text = await res.text();
    const data = text ? JSON.parse(text) : [];

    currentArchiveData = data;

    const tbody = document.getElementById('archiveRows');
    const table = document.getElementById('archiveTable');

    tbody.innerHTML = '';
    table.classList.remove('hidden');

    if(!data.length){
      tbody.innerHTML = `<tr><td colspan="8">No archived data</td></tr>`;
      return;
    }

    data.forEach(r=>{
      tbody.innerHTML += `
        <tr>
          <td>${r.id}</td>
          <td>${r.device_id}</td>
          <td>${r.p_name || ''}</td>
          <td>${r.heartrate}</td>
          <td>${r.spo2}</td>
          <td>${new Date(r.timestamp).toLocaleString()}</td>
          <td>${r.checkin_date || ''}</td>
          <td>${r.checkout_date || ''}</td>
        </tr>`;
    });

  } catch(e){
    console.error(e);
    alert('Failed to load archive');
  }
}

/* ===== EXPORT EXCEL ===== */

function exportExcel(){
  if(!currentArchiveData.length){
    alert('No data to export');
    return;
  }

  /* ÿ™ÿ≠ÿØŸäÿØ ÿßÿ≥ŸÖ ÿßŸÑÿ¥Ÿäÿ™ */
  let sheetName = 'All_Patients';

  const uniquePatients = [...new Set(
    currentArchiveData.map(r => r.p_name).filter(Boolean)
  )];

  if(uniquePatients.length === 1){
    sheetName = uniquePatients[0].replace(/[\\/*?:[\]]/g, '');
  }

  /* ÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ */
  const wsData = currentArchiveData.map(r => ({
    ID: r.id,
    Device: r.device_id,
    Patient: r.p_name,
    HeartRate: r.heartrate,
    SpO2: r.spo2,
    Date: new Date(r.timestamp).toLocaleString(),
    CheckIn: r.checkin_date || '',
    CheckOut: r.checkout_date || ''
  }));

  const ws = XLSX.utils.json_to_sheet(wsData);
  const wb = XLSX.utils.book_new();

  XLSX.utils.book_append_sheet(wb, ws, sheetName);

  XLSX.writeFile(
    wb,
    `${sheetName}.xlsx`
  );
}


/* ===== HIDE ===== */
function hideTable(){
  document.getElementById('archiveTable').classList.add('hidden');
  document.getElementById('archiveRows').innerHTML = '';
  currentArchiveData = [];
}

/* ===== ENTER SEARCH ===== */
document.getElementById('searchInput').addEventListener('keydown', e=>{
  if(e.key === 'Enter') searchArchive();
});
</script>

</body>
</html>
