<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { box-sizing:border-box; margin:0; padding:0; }

body {
  background:#020617;
  color:#e5e7eb;
  font-family:Segoe UI, Arial;
  height:100vh;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  border-bottom:1px solid rgba(255,255,255,.15);
}

header span { color:#0ea5e9; font-size:20px; }

header button {
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:#0ea5e9;
  color:#fff;
  font-weight:600;
  cursor:pointer;
}

.container {
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:20px;
}

/* status */
.status {
  text-align:center;
  font-size:20px;
  color:#22c55e;
  margin-top:40px;
}

/* results */
.results {
  display:flex;
  gap:20px;
}
.card {
  flex:1;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:20px;
  text-align:center;
}
.card h3 { color:#0ea5e9; margin-bottom:10px; }
.card .value { font-size:32px; font-weight:700; }

/* charts */
.charts {
  display:flex;
  flex-direction:column;
  gap:20px;
}
.chart-box {
  background:rgba(255,255,255,.05);
  border-radius:14px;
  padding:10px;
  height:200px;
}
canvas {
  width:100% !important;
  height:100% !important;
}
</style>
</head>

<body>

<header>
  <span id="deviceTitle"></span>
  <button onclick="location.href='admin.html'">← Back</button>
</header>

<div class="container">

  <div id="status" class="status">الجهاز متاح</div>

  <div id="content" style="display:none">

    <div class="results">
      <div class="card">
        <h3>Heart Rate</h3>
        <div class="value" id="hr">--</div>
      </div>
      <div class="card">
        <h3>SpO₂</h3>
        <div class="value" id="spo">--</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box">
        <canvas id="hrChart"></canvas>
      </div>
      <div class="chart-box">
        <canvas id="spoChart"></canvas>
      </div>
    </div>

  </div>
</div>

<script>
const params = new URLSearchParams(location.search);
const device = params.get('device') || 'max1';
document.getElementById('deviceTitle').innerText = `Device: ${device.toUpperCase()}`;

const statusEl = document.getElementById('status');
const contentEl = document.getElementById('content');

let hrData = [];
let spoData = [];
let labels = [];

const hrChart = new Chart(document.getElementById('hrChart'), {
  type:'line',
  data:{labels,datasets:[{label:'HR',data:hrData,borderColor:'#00ffff'}]},
  options:{responsive:true,maintainAspectRatio:false,animation:false}
});

const spoChart = new Chart(document.getElementById('spoChart'), {
  type:'line',
  data:{labels,datasets:[{label:'SpO₂',data:spoData,borderColor:'#ff00ff'}]},
  options:{responsive:true,maintainAspectRatio:false,animation:false}
});

function showAvailable() {
  statusEl.style.display = 'block';
  contentEl.style.display = 'none';

  hrData.length = 0;
  spoData.length = 0;
  labels.length = 0;

  hrChart.update();
  spoChart.update();
}

function showData(data) {
  statusEl.style.display = 'none';
  contentEl.style.display = 'block';

  document.getElementById('hr').innerText = data.heartrate;
  document.getElementById('spo').innerText = data.spo2;

  labels.push('');
  hrData.push(data.heartrate);
  spoData.push(data.spo2);

  if (labels.length > 20) {
    labels.shift();
    hrData.shift();
    spoData.shift();
  }

  hrChart.update();
  spoChart.update();
}

async function loadData() {
  try {
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    if (!data || !data.time) {
      showAvailable();
      return;
    }

    const last = new Date(data.time).getTime();
    if (Date.now() - last > 10000) {
      showAvailable();
      return;
    }

    showData(data);

  } catch {
    showAvailable();
  }
}

loadData();
setInterval(loadData, 2000);
</script>

</body>
</html>
