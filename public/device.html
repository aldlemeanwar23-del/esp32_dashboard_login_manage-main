<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; margin:0; padding:0; }
body, html { width:100%; height:100%; font-family:'Segoe UI', Arial; background:#0a0f1a; color:#fff; }

header {
  display:flex; justify-content:space-between; align-items:center;
  padding:15px 25px; background:#001f2f; color:#00ffff; font-size:20px;
}
header button {
  padding:8px 16px; border:none; border-radius:6px;
  background:#00ffff; color:#020617; font-weight:bold; cursor:pointer;
}
header button:hover { background:#00bcd4; }

.container {
  display:flex; flex-direction:column; height:calc(100% - 60px); padding:15px 20px; gap:15px;
}

.results {
  display: flex;
  justify-content: center;
  gap: 15px;
}

.result-card, .patient-card {
  flex: 0 0 250px; 
  background: rgba(0,255,255,0.1);
  padding: 12px;
  border-radius: 12px;
  text-align: center;
  transition:0.3s;
}

.result-card h3, .patient-card h3 {
  font-size:20px;
  color:#00ffff;
  margin-bottom:8px;
}

.result-card .value, .patient-card .value {
  font-size:22px;
  font-weight:bold;
}

.charts {
  display:flex; flex-direction:column; align-items:center; gap:15px;
}
.chart-container {
  width:90%; height:180px; 
}

.status-msg {
  text-align:center;
  font-size:22px;
  font-weight:bold;
  color:#22c55e;
  margin-top:30px;
  display:none;
}
</style>
</head>
<body>

<header>
  <span>Device Details: <span id="deviceName"></span></span>
  <button onclick="location.href='admin.html'">← Back</button>
</header>

<div class="container">
  <div class="results" id="results">
    <div class="result-card">
      <h3>Heart Rate</h3>
      <div class="value" id="hr">-- BPM</div>
    </div>
    <div class="result-card">
      <h3>SpO₂</h3>
      <div class="value" id="spo">-- %</div>
    </div>
    <div class="patient-card">
      <h3>Patient Name</h3>
      <div class="value" id="patientName">--</div>
    </div>
  </div>

  <div class="charts" id="charts">
    <div class="chart-container"><canvas id="hrChart"></canvas></div>
    <div class="chart-container"><canvas id="spoChart"></canvas></div>
  </div>
<br><br><br>
  <div style = "font-size:30px;" class="status-msg" id="statusMsg">لا توجد بيانات</div>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const device = params.get('device') || 'max1';
document.getElementById('deviceName').innerText = device.toUpperCase();

let labels=[], hrData=[], spoData=[];

const hrChart = new Chart(document.getElementById('hrChart'), {
  type:'line',
  data:{ labels, datasets:[{label:'Heart Rate', data:hrData, borderColor:'#00ffff', backgroundColor:'rgba(0,255,255,0.2)', fill:true, tension:0.2}]},
  options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{y:{beginAtZero:true}} }
});

const spoChart = new Chart(document.getElementById('spoChart'), {
  type:'line',
  data:{ labels, datasets:[{label:'SpO₂', data:spoData, borderColor:'#ff00ff', backgroundColor:'rgba(255,0,255,0.2)', fill:true, tension:0.2}]},
  options:{ responsive:true, maintainAspectRatio:false, animation:false, scales:{y:{beginAtZero:true}} }
});

// تفريغ البيانات وعرض رسالة عند فقدان الاتصال
function clearData() {
  document.getElementById('hr').innerText = '-- BPM';
  document.getElementById('spo').innerText = '-- %';
  document.getElementById('patientName').innerText = '--';
  labels.length = hrData.length = spoData.length = 0;
  hrChart.update();
  spoChart.update();
  document.getElementById('results').style.display = 'none';
  document.getElementById('charts').style.display = 'none';
  document.getElementById('statusMsg').style.display = 'block';
}

// عرض البيانات عند الاتصال
function showData(last, patient){
  document.getElementById('hr').innerText = last.heartrate+' BPM';
  document.getElementById('spo').innerText = last.spo2+' %';
  document.getElementById('patientName').innerText = patient || '--';

  labels.push('');
  hrData.push(last.heartrate);
  spoData.push(last.spo2);

  if(labels.length > 50){
    labels.shift();
    hrData.shift();
    spoData.shift();
  }

  hrChart.update();
  spoChart.update();

  document.getElementById('results').style.display = 'flex';
  document.getElementById('charts').style.display = 'flex';
  document.getElementById('statusMsg').style.display = 'none';
}

// جلب اسم المريض من API
async function loadPatientName() {
  try {
    const res = await fetch('/api/infoGet');
    const data = await res.json();
    const patient = data.find(p => p.device_id === device);
    return patient ? patient.p_name : '--';
  } catch {
    return '--';
  }
}

// جلب بيانات الجهاز
async function loadData(){
  try{
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();
    const patientName = await loadPatientName();

    if(!data || data.length === 0){
      clearData();
      return;
    }

    const last = data[data.length-1];
    const age = Date.now() - new Date(last.time).getTime();
    if(age > 10000){ // إذا كانت البيانات قديمة
      clearData();
      return;
    }

    showData(last, patientName);

  }catch(e){ 
    clearData(); 
  }
}

// تحميل البيانات كل ثانيتين
loadData();
setInterval(loadData, 2000);
</script>

</body>
</html>
