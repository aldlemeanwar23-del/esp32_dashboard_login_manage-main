<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
* { box-sizing:border-box; margin:0; padding:0; }

body {
  font-family:Segoe UI, Arial;
  background:#020617;
  color:#e5e7eb;
  height:100vh;
}

header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  background:#020617;
  border-bottom:1px solid rgba(255,255,255,.15);
}

header span {
  color:#0ea5e9;
  font-size:20px;
  font-weight:700;
}

header button {
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:#0ea5e9;
  color:#020617;
  font-weight:700;
  cursor:pointer;
}

.container {
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:15px;
}

/* ===== Status ===== */
.status {
  text-align:center;
  font-size:22px;
  font-weight:700;
  color:#22c55e;
  padding:40px 0;
}

.hidden { display:none; }

/* ===== Results ===== */
.results {
  display:flex;
  gap:15px;
}
.result-card {
  flex:1;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:15px;
  text-align:center;
}
.result-card h3 {
  font-size:15px;
  color:#0ea5e9;
  margin-bottom:8px;
}
.result-card .value {
  font-size:26px;
  font-weight:700;
}

/* ===== Charts ===== */
.charts {
  display:flex;
  gap:15px;
}
.chart-box {
  flex:1;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:10px;
  height:260px;
}

canvas {
  width:100% !important;
  height:100% !important;
}

@media(max-width:900px) {
  .results, .charts { flex-direction:column; }
}
</style>
</head>

<body>

<header>
  <span>Device: <span id="deviceName"></span></span>
  <button onclick="location.href='admin.html'">← Back</button>
</header>

<div class="container">

  <div class="status" id="status">الجهاز متاح</div>

  <div id="content" class="hidden">
    <div class="results">
      <div class="result-card">
        <h3>Heart Rate</h3>
        <div class="value" id="hr">--</div>
      </div>
      <div class="result-card">
        <h3>SpO₂</h3>
        <div class="value" id="spo">--</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box"><canvas id="hrChart"></canvas></div>
      <div class="chart-box"><canvas id="spoChart"></canvas></div>
    </div>
  </div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const device = params.get('device');
document.getElementById('deviceName').innerText = device?.toUpperCase() || '';

const TIMEOUT = 7000;

let hrChart = new Chart(document.getElementById('hrChart'), {
  type:'line',
  data:{ labels:[], datasets:[{ data:[], borderColor:'#00ffff', fill:false }]},
  options:{ responsive:true, animation:false }
});

let spoChart = new Chart(document.getElementById('spoChart'), {
  type:'line',
  data:{ labels:[], datasets:[{ data:[], borderColor:'#ff00ff', fill:false }]},
  options:{ responsive:true, animation:false }
});

function setOffline() {
  document.getElementById('status').classList.remove('hidden');
  document.getElementById('content').classList.add('hidden');

  document.getElementById('hr').innerText = '--';
  document.getElementById('spo').innerText = '--';

  hrChart.data.labels = [];
  hrChart.data.datasets[0].data = [];
  hrChart.update();

  spoChart.data.labels = [];
  spoChart.data.datasets[0].data = [];
  spoChart.update();
}

async function loadData() {
  try {
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    if (!data || data.length === 0) {
      setOffline();
      return;
    }

    const last = data[data.length - 1];
    const lastTime = new Date(last.time).getTime();

    if (Date.now() - lastTime > TIMEOUT) {
      setOffline();
      return;
    }

    document.getElementById('status').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');

    document.getElementById('hr').innerText = last.heartrate + ' BPM';
    document.getElementById('spo').innerText = last.spo2 + ' %';

    hrChart.data.labels = data.map(()=>'');
    hrChart.data.datasets[0].data = data.map(r => r.heartrate);
    hrChart.update();

    spoChart.data.labels = data.map(()=>'');
    spoChart.data.datasets[0].data = data.map(r => r.spo2);
    spoChart.update();

  } catch {
    setOffline();
  }
}

loadData();
setInterval(loadData, 2000);
</script>

</body>
</html>
