<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body, html {
  width: 100%;
  height: 100%;
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #0a0f1a;
  color: #fff;
}
header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 25px;
  background: #001f2f;
  color: #00ffff;
  font-size: 20px;
}
header button {
  padding: 8px 16px;
  border: none;
  border-radius: 6px;
  background: #00ffff;
  color: #020617;
  font-weight: bold;
  cursor: pointer;
}
header button:hover { background: #00bcd4; }

.container {
  display: flex;
  flex-direction: column;
  height: calc(100% - 60px);
  padding: 15px 20px;
  gap: 15px;
  justify-content: flex-start;
  align-items: center;
}

/* النتائج */
.results {
  display: flex;
  justify-content: center;
  gap: 15px;
  width: 100%;
}
.result-card {
  width: 200px;
  background: rgba(0, 255, 255, 0.1);
  padding: 15px;
  border-radius: 12px;
  text-align: center;
}
.result-card h3 {
  font-size: 16px;
  color: #00ffff;
  margin-bottom: 10px;
}
.result-card .value {
  font-size: 28px;
  font-weight: bold;
}

/* الرسوم البيانية */
canvas {
  width: 90% !important;
  max-width: 600px;
  height: 200px !important;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 12px;
  padding: 5px;
  margin-top: 15px;
}

.empty-message {
  font-size: 18px;
  color: #00ffff;
  margin: 20px 0;
}
</style>
</head>
<body>

<header>
  <span>Device Details: <span id="deviceName"></span></span>
  <button onclick="location.href='admin.html'">← Back</button>
</header>

<div class="container">
  <div class="results">
    <div class="result-card">
      <h3>Heart Rate</h3>
      <div class="value" id="hr">-- BPM</div>
    </div>
    <div class="result-card">
      <h3>SpO₂</h3>
      <div class="value" id="spo">-- %</div>
    </div>
  </div>

  <div id="emptyMessage" class="empty-message" style="display:none;">الجهاز متاح</div>

  <canvas id="hrChart"></canvas>
  <canvas id="spoChart"></canvas>
</div>

<script>
const params = new URLSearchParams(window.location.search);
const device = params.get('device') || 'max1';
document.getElementById('deviceName').innerText = device.toUpperCase();

let labels = [], hrData = [], spoData = [];

const hrChart = new Chart(document.getElementById('hrChart'), {
  type:'line',
  data:{labels, datasets:[{label:'Heart Rate', data:hrData, borderColor:'#00ffff', fill:true}]},
  options:{responsive:true, animation:false, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
});

const spoChart = new Chart(document.getElementById('spoChart'), {
  type:'line',
  data:{labels, datasets:[{label:'SpO₂', data:spoData, borderColor:'#ff00ff', fill:true}]},
  options:{responsive:true, animation:false, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
});

async function loadData() {
  try {
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    const emptyMsg = document.getElementById('emptyMessage');
    const hrVal = document.getElementById('hr');
    const spoVal = document.getElementById('spo');

    if (!data || data.length === 0) {
      hrVal.innerText = '-- BPM';
      spoVal.innerText = '-- %';
      emptyMsg.style.display = 'block';

      labels.length = hrData.length = spoData.length = 0;
      hrChart.update();
      spoChart.update();
      return;
    }

    emptyMsg.style.display = 'none';

    // ترتيب البيانات حسب timestamp
    const sortedData = data.sort((a,b) => new Date(a.time) - new Date(b.time));

    // آخر قراءة
    const last = sortedData[sortedData.length-1];
    hrVal.innerText = last.heartrate + ' BPM';
    spoVal.innerText = last.spo2 + ' %';

    // عرض آخر 50 نقطة
    const recent = sortedData.slice(-50);

    labels.length = hrData.length = spoData.length = 0;
    recent.forEach(r => {
      const timeLabel = new Date(r.time).toLocaleTimeString();
      labels.push(timeLabel);
      hrData.push(r.heartrate);
      spoData.push(r.spo2);
    });

    hrChart.update();
    spoChart.update();

  } catch(err) {
    console.error('Error fetching device data:', err);
  }
}

// تحميل أول مرة + تحديث كل 2 ثانية
loadData();
setInterval(loadData, 2000);
</script>

</body>
</html>
