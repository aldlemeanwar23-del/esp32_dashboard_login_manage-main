<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body,html{
  width:100%;height:100%;
  font-family:Segoe UI,Arial;
  background:#0a0f1a;
  color:#fff;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  background:#001f2f;
  color:#00ffff;
}
header button{
  padding:8px 16px;
  border:none;
  border-radius:6px;
  background:#00ffff;
  font-weight:bold;
  cursor:pointer;
}

.container{
  display:flex;
  flex-direction:column;
  height:calc(100% - 60px);
  padding:15px;
  gap:15px;
}

/* النتائج */
.results{
  display:flex;
  gap:15px;
}
.card{
  flex:1;
  background:rgba(0,255,255,.1);
  padding:15px;
  border-radius:12px;
  text-align:center;
}
.card h3{color:#00ffff;margin-bottom:8px}
.value{font-size:28px;font-weight:bold}

/* الحالة */
.status{
  text-align:center;
  font-size:22px;
  font-weight:bold;
  color:#22c55e;
  display:none;
}

/* Charts */
.charts{
  display:flex;
  gap:15px;
}
canvas{
  flex:1;
  height:180px;
  background:rgba(0,0,0,.3);
  border-radius:12px;
  padding:5px;
}
</style>
</head>

<body>

<header>
  <span>Device: <b id="deviceName"></b></span>
  <button onclick="location.href='admin.html'">← Back</button>
</header>

<div class="container">

  <div class="status" id="status">الجهاز متاح</div>

  <div class="results" id="results">
    <div class="card">
      <h3>Heart Rate</h3>
      <div class="value" id="hr">--</div>
    </div>
    <div class="card">
      <h3>SpO₂</h3>
      <div class="value" id="spo">--</div>
    </div>
  </div>

  <div class="charts">
    <canvas id="hrChart"></canvas>
    <canvas id="spoChart"></canvas>
  </div>
</div>

<script>
const device = new URLSearchParams(location.search).get('device') || 'max1';
document.getElementById('deviceName').innerText = device.toUpperCase();

const labels=[], hrData=[], spoData=[];

const hrChart = new Chart(hrChartElem(), {
  type:'line',
  data:{labels,datasets:[{data:hrData,borderColor:'#00ffff'}]},
  options:{responsive:true,animation:false}
});
const spoChart = new Chart(spoChartElem(), {
  type:'line',
  data:{labels,datasets:[{data:spoData,borderColor:'#ff00ff'}]},
  options:{responsive:true,animation:false}
});

function hrChartElem(){return document.getElementById('hrChart')}
function spoChartElem(){return document.getElementById('spoChart')}

function clearUI(){
  document.getElementById('status').style.display='block';
  document.getElementById('results').style.display='none';
  labels.length=hrData.length=spoData.length=0;
  hrChart.update(); spoChart.update();
}

function showUI(row){
  document.getElementById('status').style.display='none';
  document.getElementById('results').style.display='flex';

  document.getElementById('hr').innerText=row.heartrate;
  document.getElementById('spo').innerText=row.spo2;

  labels.push('');
  hrData.push(row.heartrate);
  spoData.push(row.spo2);

  if(labels.length>20){
    labels.shift(); hrData.shift(); spoData.shift();
  }
  hrChart.update(); spoChart.update();
}

async function loadData(){
  try{
    const res=await fetch(`/api/sensor?device=${device}`);
    const data=await res.json();

    if(!Array.isArray(data)||data.length===0){
      clearUI(); return;
    }

    const last=data[data.length-1];
    const age=Date.now()-new Date(last.time).getTime();

    if(age>10000){
      clearUI(); return;
    }

    showUI(last);

  }catch{
    clearUI();
  }
}

loadData();
setInterval(loadData,2000);
</script>

</body>
</html>
