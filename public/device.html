<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
  --primary:#38bdf8;
  --bg:#020617;
  --card:rgba(255,255,255,.07);
  --border:rgba(255,255,255,.15);
}

body {
  margin:0;
  font-family:Segoe UI, Arial;
  background:var(--bg);
  color:#e5e7eb;
}

/* Top bar */
.top-bar {
  display:flex;
  align-items:center;
  gap:15px;
  padding:18px 30px;
  background:#0f172a;
  border-bottom:1px solid var(--border);
}

.top-bar h2 {
  margin:0;
  color:var(--primary);
}

.back-btn {
  background:none;
  border:1px solid var(--border);
  color:#e5e7eb;
  padding:8px 14px;
  border-radius:8px;
  cursor:pointer;
}

.back-btn:hover {
  background:rgba(255,255,255,.08);
}

/* Layout */
.container {
  max-width:1100px;
  margin:auto;
  padding:30px;
}

.info-grid {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.info-card {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:16px;
  padding:22px;
  text-align:center;
  box-shadow:0 10px 25px rgba(0,0,0,.4);
}

.info-card h4 {
  margin:0 0 8px;
  font-weight:500;
  opacity:.7;
}

.info-card .value {
  font-size:26px;
  font-weight:700;
  color:var(--primary);
}

/* Charts */
.chart-card {
  background:var(--card);
  border:1px solid var(--border);
  border-radius:18px;
  padding:22px;
  margin-bottom:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.4);
}

.chart-card h3 {
  margin:0 0 15px;
  color:var(--primary);
}

canvas {
  height:260px !important;
}
</style>
</head>

<body>

<!-- Top -->
<div class="top-bar">
  <button class="back-btn" onclick="history.back()">‚Üê Back</button>
  <h2 id="title">Device</h2>
</div>

<div class="container">

  <!-- Summary -->
  <div class="info-grid">
    <div class="info-card">
      <h4>Heart Rate</h4>
      <div class="value" id="hr">--</div>
    </div>
    <div class="info-card">
      <h4>SpO‚ÇÇ</h4>
      <div class="value" id="spo">--</div>
    </div>
    <div class="info-card">
      <h4>Last Update</h4>
      <div class="value" id="time" style="font-size:16px">--</div>
    </div>
  </div>

  <!-- Charts -->
  <div class="chart-card">
    <h3>Heart Rate Trend</h3>
    <canvas id="hrChart"></canvas>
  </div>

  <div class="chart-card">
    <h3>SpO‚ÇÇ Trend</h3>
    <canvas id="spoChart"></canvas>
  </div>

</div>

<script>
// Get device
const params = new URLSearchParams(location.search);
const device = params.get('device');

if (!device) {
  alert('No device selected');
  history.back();
}

document.getElementById('title').innerText =
  'üìü Device Details ‚Äì ' + device.toUpperCase();

// Charts
const hrChart = new Chart(
  document.getElementById('hrChart'),
  {
    type:'line',
    data:{
      labels:[],
      datasets:[{
        label:'Heart Rate',
        data:[],
        borderColor:'#38bdf8',
        backgroundColor:'rgba(56,189,248,.2)',
        fill:true,
        tension:.4
      }]
    },
    options:{ animation:false }
  }
);

const spoChart = new Chart(
  document.getElementById('spoChart'),
  {
    type:'line',
    data:{
      labels:[],
      datasets:[{
        label:'SpO‚ÇÇ',
        data:[],
        borderColor:'#22c55e',
        backgroundColor:'rgba(34,197,94,.2)',
        fill:true,
        tension:.4
      }]
    },
    options:{ animation:false }
  }
);

// Load data
async function loadData() {
  try {
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    if (!Array.isArray(data) || data.length === 0) return;

    const last = data[data.length - 1];

    document.getElementById('hr').innerText =
      last.heartrate + ' BPM';
    document.getElementById('spo').innerText =
      last.spo2 + ' %';
    document.getElementById('time').innerText =
      new Date(last.time).toLocaleString();

    hrChart.data.labels = data.map(()=>'');
    hrChart.data.datasets[0].data = data.map(d=>d.heartrate);
    hrChart.update();

    spoChart.data.labels = data.map(()=>'');
    spoChart.data.datasets[0].data = data.map(d=>d.spo2);
    spoChart.update();

  } catch (e) {
    console.error(e);
  }
}

loadData();
setInterval(loadData, 2000);
</script>

</body>
</html>
