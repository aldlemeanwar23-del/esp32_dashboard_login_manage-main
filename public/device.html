<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Device Details</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{box-sizing:border-box;margin:0;padding:0}
body{
  background:#020617;
  color:#e5e7eb;
  font-family:Segoe UI,Arial;
  height:100vh;
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:15px 25px;
  border-bottom:1px solid rgba(255,255,255,.15);
}
header span{color:#0ea5e9;font-size:20px;font-weight:700}
header button{
  padding:8px 16px;
  border:none;
  border-radius:8px;
  background:#0ea5e9;
  color:#020617;
  font-weight:700;
  cursor:pointer;
}
.container{
  padding:20px;
  display:flex;
  flex-direction:column;
  gap:15px;
}
.status{
  text-align:center;
  font-size:22px;
  font-weight:700;
  color:#22c55e;
  padding:50px 0;
}
.hidden{display:none}
.results{
  display:flex;
  gap:15px;
}
.result-card{
  flex:1;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:15px;
  text-align:center;
}
.result-card h3{color:#0ea5e9;font-size:15px;margin-bottom:8px}
.result-card .value{font-size:26px;font-weight:700}
.charts{
  display:flex;
  gap:15px;
}
.chart-box{
  flex:1;
  height:260px;
  background:rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.15);
  border-radius:14px;
  padding:10px;
}
canvas{width:100%!important;height:100%!important}
@media(max-width:900px){
  .results,.charts{flex-direction:column}
}
</style>
</head>

<body>

<header>
  <span>Device: <span id="deviceName"></span></span>
  <button onclick="location.href='admin.html'">← Back</button>
</header>

<div class="container">

  <div id="status" class="status">الجهاز متاح</div>

  <div id="content" class="hidden">
    <div class="results">
      <div class="result-card">
        <h3>Heart Rate</h3>
        <div class="value" id="hr">--</div>
      </div>
      <div class="result-card">
        <h3>SpO₂</h3>
        <div class="value" id="spo">--</div>
      </div>
    </div>

    <div class="charts">
      <div class="chart-box"><canvas id="hrChart"></canvas></div>
      <div class="chart-box"><canvas id="spoChart"></canvas></div>
    </div>
  </div>

</div>

<script>
const params=new URLSearchParams(location.search);
const device=params.get('device');
document.getElementById('deviceName').innerText=device?.toUpperCase()||'';

const TIMEOUT=7000;
const MAX_POINTS=30;

let hrBuffer=[],spoBuffer=[],labels=[];

const hrChart=new Chart(hrChartEl={
  getContext:()=>document.getElementById('hrChart').getContext('2d')
}.getContext(),{
  type:'line',
  data:{labels:labels,datasets:[{data:hrBuffer,borderColor:'#00ffff',fill:false}]},
  options:{responsive:true,animation:false}
});

const spoChart=new Chart(spoChartEl={
  getContext:()=>document.getElementById('spoChart').getContext('2d')
}.getContext(),{
  type:'line',
  data:{labels:labels,datasets:[{data:spoBuffer,borderColor:'#ff00ff',fill:false}]},
  options:{responsive:true,animation:false}
});

function setOffline(){
  document.getElementById('status').classList.remove('hidden');
  document.getElementById('content').classList.add('hidden');
  hrBuffer.length=spoBuffer.length=labels.length=0;
  hrChart.update();spoChart.update();
}

async function loadData(){
  try{
    const res=await fetch(`/api/sensor?device=${device}`);
    const d=await res.json();

    if(!d || !d.time){setOffline();return;}

    const t=new Date(d.time).getTime();
    if(Date.now()-t>TIMEOUT){setOffline();return;}

    document.getElementById('status').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');

    document.getElementById('hr').innerText=d.heartrate+' BPM';
    document.getElementById('spo').innerText=d.spo2+' %';

    hrBuffer.push(d.heartrate);
    spoBuffer.push(d.spo2);
    labels.push('');

    if(hrBuffer.length>MAX_POINTS){
      hrBuffer.shift();spoBuffer.shift();labels.shift();
    }

    hrChart.update();spoChart.update();
  }catch{setOffline();}
}

loadData();
setInterval(loadData,2000);
</script>

</body>
</html>
