<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Patients</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Ù…ÙƒØªØ¨Ø© SheetJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
:root {
  --primary: #0ea5e9;
  --secondary: #00ffff;
  --bg: #0c111b;
  --card-bg: rgba(255,255,255,0.05);
  --border: rgba(255,255,255,0.2);
  --hover: rgba(0,255,255,0.1);
  --btn-save: #22c55e;
  --btn-delete: #ef4444;
  --btn-archive: #f59e0b;
  --font: 'Segoe UI', Arial, sans-serif;
}

body {
  margin:0;
  font-family: var(--font);
  background: var(--bg);
  color: #fff;
}

h2 {
  text-align:center;
  color: var(--secondary);
  margin: 20px 0;
  font-size: 28px;
}

.top-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:95%;
  margin:auto;
  padding:10px 0;
}

.top-bar button {
  padding: 8px 16px;
  border: none;
  border-radius: 8px;
  background: var(--primary);
  color: #fff;
  font-weight: 600;
  cursor: pointer;
  transition: 0.2s;
}
.top-bar button:hover { background: var(--btn-archive); }

table {
  width:95%;
  margin:auto;
  border-collapse:separate;
  border-spacing:0;
  background: var(--card-bg);
  border-radius:12px;
  overflow:hidden;
  box-shadow: 0 5px 15px rgba(0,255,255,0.15);
}

th, td {
  padding:8px 6px;
  text-align:center;
  font-size:14px;
  border-bottom:1px solid var(--border);
}

th { background:#001f2f; position: sticky; top:0; z-index:2; }
tr:hover { background: var(--hover); }

input.inline-input {
  width: 100%;
  padding:6px 4px;
  border-radius:5px;
  border:1px solid var(--border);
  background: #020617;
  color:#fff;
  font-size:14px;
  text-align:center;
}

input.device-id {
  width: 70px;
  text-align:center;
}

td.actions {
  display:flex;
  justify-content:center;
  gap:4px;
}

button.action-btn {
  padding:4px 8px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  font-weight:bold;
  transition: 0.1s;
}
button.action-btn:hover { transform: scale(1.05); }
button.save { background: var(--btn-save); color:#020617; }
button.delete { background: var(--btn-delete); color:#fff; }
button.archive { background: var(--btn-archive); color:#020617; }

@media (max-width: 768px) {
  table, thead, tbody, th, td, tr { display:block; }
  tr { margin-bottom:15px; }
  th, td { text-align:right; padding-right:15px; position:relative; }
  td::before { position:absolute; left:10px; text-align:left; font-weight:bold; white-space:nowrap; content: attr(data-label); color:#00ffff; }
  th::before { display:none; }
}
</style>
</head>

<body>

<script>
if(localStorage.getItem('auth')!=='1') location.href='/login.html';
</script>

<div class="top-bar">
  <h2>ğŸ§¾ Patient Management</h2>
  <button onclick="location.href='admin.html'">â† Back</button>
</div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Device</th>
<th>Patient</th>
<th>Mobile</th>
<th>Email</th>
<th>Age</th>
<th>CheckIn</th>
<th>CheckOut</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
const dOnly = v => v ? v.split('T')[0] : '';

async function loadPatients(){
  const res = await fetch('/api/infoGet');
  const data = await res.json();
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';

  data.forEach(r=>{
    tbody.innerHTML += `
<tr data-device="${r.device_id}">
<td data-label="ID">${r.id}</td>
<td data-label="Device"><input class="device-id" value="${r.device_id}" disabled></td>
<td data-label="Patient"><input class="pname inline-input" value="${r.p_name || ''}"></td>
<td data-label="Mobile"><input class="pmobile inline-input" value="${r.ph_no || ''}"></td>
<td data-label="Email"><input class="email inline-input" value="${r.email || ''}"></td>
<td data-label="Age"><input class="age inline-input" value="${r.age || ''}"></td>
<td data-label="CheckIn"><input type="date" class="chin inline-input" value="${dOnly(r.checkin_date)}"></td>
<td data-label="CheckOut"><input type="date" class="chout inline-input" value="${dOnly(r.checkout_date)}"></td>
<td data-label="Actions" class="actions">
  <button class="action-btn save" onclick="saveRow(this)">ğŸ’¾</button>
  <button class="action-btn delete" onclick="deletePatient(${r.id})">ğŸ—‘</button>
  <button class="action-btn archive" onclick="archivePatient('${r.device_id}')">ğŸ“¦</button>
</td>
</tr>`;
  });
}

async function saveRow(btn){
  const row = btn.closest('tr');
  const body = {
    device_id: row.dataset.device,
    pname: row.querySelector('.pname').value,
    pmobile: row.querySelector('.pmobile').value,
    email: row.querySelector('.email').value,
    age: Number(row.querySelector('.age').value) || null,
    chin: row.querySelector('.chin').value || null,
    chout: row.querySelector('.chout').value || null
  };

  try {
    const res = await fetch('/api/update',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });
    if(!res.ok) throw await res.json();
    loadPatients();
    alert('Patient updated successfully');
  } catch(e){
    console.error(e);
    alert('Update failed');
  }
}

// Ø£Ø±Ø´ÙØ© Ø§Ù„Ù…Ø±ÙŠØ¶ + Ø¬Ù…ÙŠØ¹ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø² + Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel

async function archivePatient(device_id){
  if(!confirm('Archive patient and download full Excel archive?')) return;

  try {
    /* =========================
       1) Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
       ========================= */
    const pRes = await fetch('/api/infoGet');
    const patients = await pRes.json();
    const patient = patients.find(p => p.device_id === device_id);
    if(!patient){
      alert('Patient not found');
      return;
    }

    /* =========================
       2) Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø¬Ù‡Ø§Ø²
       ========================= */
    const sRes = await fetch(`/api/sensor?device=${device_id}`);
    const sensorData = await sRes.json();

    if(!Array.isArray(sensorData) || sensorData.length === 0){
      alert('No sensor data found for this device');
      return;
    }

    /* =========================
       3) Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel
       ========================= */
    const wb = XLSX.utils.book_new();

    // ğŸ”¹ Sheet 1 : Patient Info
    const patientSheet = XLSX.utils.json_to_sheet([{
      ID: patient.id,
      Device: patient.device_id,
      Patient: patient.p_name,
      Mobile: patient.ph_no,
      Email: patient.email,
      Age: patient.age,
      CheckIn: patient.checkin_date,
      CheckOut: patient.checkout_date
    }]);
    XLSX.utils.book_append_sheet(wb, patientSheet, 'Patient Info');

    // ğŸ”¹ Sheet 2 : Sensor Data
    const sensorSheet = XLSX.utils.json_to_sheet(
      sensorData.map(r => ({
        Time: r.time || r.timestamp,
        HeartRate: r.heartrate,
        SpO2: r.spo2
      }))
    );
    XLSX.utils.book_append_sheet(wb, sensorSheet, 'Sensor Data');

    // â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù ÙØ¹Ù„ÙŠÙ‹Ø§
    XLSX.writeFile(wb, `Archive_${device_id}_${Date.now()}.xlsx`);

    /* =========================
       4) Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
       ========================= */
    const aRes = await fetch('/api/archive',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ device_id })
    });

    const aResult = await aRes.json();
    if(!aResult.success){
      alert('Archive DB failed: ' + (aResult.error || ''));
      return;
    }

    alert('Archive completed & Excel downloaded âœ”');
    loadPatients();

  } catch(err){
    console.error(err);
    alert('Archive failed (JS Error)');
  }
}

async function deletePatient(id){
  if(!confirm('Delete patient?')) return;
  await fetch('/api/infoDelete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id})
  });
  loadPatients(); 
}

loadPatients();
</script>

</body>
</html>
