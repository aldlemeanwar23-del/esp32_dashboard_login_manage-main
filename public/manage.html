<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
async function archivePatient(device_id){
  if(!confirm('Archive this patient and create Excel file?')) return;

  try {
    // 1️⃣ جلب بيانات المريض
    const resData = await fetch('/api/infoGet');
    const patients = await resData.json();
    const patient = patients.find(p => p.device_id === device_id);
    if(!patient) return alert('Patient not found');

    // 2️⃣ أرشفة المريض
    const resArchive = await fetch('/api/archive',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ device_id })
    });
    const result = await resArchive.json();
    if(!result.success) return alert('Archive failed: ' + (result.error || 'Unknown error'));

    // 3️⃣ جلب بيانات المستشعر (يمكن أن تكون فارغة)
    let sensorData = [];
    try{
      const resSensor = await fetch(`/api/sensorArchive?device=${device_id}`);
      sensorData = await resSensor.json();
    } catch(e){ console.warn('No sensor data', e); }

    // 4️⃣ إنشاء ملف Excel
    const wb = XLSX.utils.book_new();

    // ورقة بيانات المريض
    const wsPatient = XLSX.utils.aoa_to_sheet([
      ['ID','Device','Patient','Mobile','Email','Age','CheckIn','CheckOut'],
      [patient.id, patient.device_id, patient.p_name, patient.ph_no, patient.email, patient.age, patient.checkin_date, patient.checkout_date]
    ]);
    XLSX.utils.book_append_sheet(wb, wsPatient, 'Patient Info');

    // ورقة بيانات المستشعر (حتى لو فارغة)
    if(sensorData.length > 0){
      const wsSensor = XLSX.utils.json_to_sheet(sensorData);
      XLSX.utils.book_append_sheet(wb, wsSensor, 'Sensor Data');
    } else {
      const wsSensor = XLSX.utils.aoa_to_sheet([['No sensor data available']]);
      XLSX.utils.book_append_sheet(wb, wsSensor, 'Sensor Data');
    }

    // 5️⃣ تنزيل الملف
    XLSX.writeFile(wb, `Archive_${device_id}.xlsx`);

    alert('Patient archived and Excel file created!');
    loadPatients();

  } catch(e){
    console.error(e);
    alert('Archive failed');
  }
}
</script>
