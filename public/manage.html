<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Patients</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{background:#0a0f1a;color:#fff;font-family:Segoe UI}
h2{color:#00ffff}
table{width:95%;margin:auto;border-collapse:collapse}
th,td{border:1px solid #00ffff44;padding:6px;text-align:center}
th{background:#001f2f}
input{width:100%;padding:6px;border-radius:6px;border:none}
button{padding:6px 10px;border:none;border-radius:6px;background:#00ffff;font-weight:bold;cursor:pointer}
button:hover{background:#00bcd4;color:#fff}
.form{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;width:95%;margin:15px auto}
.top-bar{display:flex;justify-content:space-between;align-items:center;width:95%;margin:15px auto}
.action-btns button{margin:2px}
</style>
</head>

<body>

<script>
if(localStorage.getItem('auth')!=='1') location.href='login.html';
</script>

<div class="top-bar">
  <h2>üßæ Patient Management</h2>
  <button onclick="location.href='admin.html'">‚Üê Back</button>
</div>

<div class="form">
  <input id="device_id" placeholder="Device ID">
  <input id="pname" placeholder="Patient Name">
  <input id="pmobile" placeholder="Mobile">
  <input id="email" placeholder="Email">
  <input id="age" placeholder="Age">
  <input id="chin" type="date">
  <button onclick="addPatient()">Add Patient</button>
</div>

<table>
<thead>
<tr>
<th>ID</th><th>Device</th><th>Name</th><th>Mobile</th>
<th>Email</th><th>Age</th><th>Check In</th><th>Check Out</th><th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
function toDateInput(v){
  if(!v) return '';
  return new Date(v).toISOString().split('T')[0];
}

async function loadPatients(){
  const res = await fetch('/api/infoGet');
  const data = await res.json();
  const tbody = document.getElementById('rows');
  tbody.innerHTML='';

  data.forEach(r=>{
    tbody.innerHTML+=`
<tr data-id="${r.id}">
<td>${r.id}</td>
<td class="device_id"><input value="${r.device_id||''}"></td>
<td class="p_name"><input value="${r.p_name||''}"></td>
<td class="ph_no"><input value="${r.ph_no||''}"></td>
<td class="email"><input value="${r.email||''}"></td>
<td class="age"><input value="${r.age||''}"></td>
<td class="checkin_date">
  <input type="date" value="${toDateInput(r.checkin_date)}">
</td>
<td class="checkout_date">
  <input type="date" value="${toDateInput(r.checkout_date)}">
</td>
<td class="action-btns">
  <button onclick="saveRow(this)">üíæ Save</button>
  <button onclick="deletePatient(${r.id})">üóë</button>
</td>
</tr>`;
  });
}

async function addPatient(){
  const body={
    device_id:device_id.value,
    pname:pname.value,
    pmobile:pmobile.value,
    email:email.value,
    age:Number(age.value),
    chin:chin.value
  };

  if(!body.device_id||!body.pname){
    alert('Device ID & Patient Name required');
    return;
  }

  await fetch('/api/add',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });

  device_id.value=pname.value=pmobile.value=email.value=age.value=chin.value='';
  loadPatients();
}

async function saveRow(btn){
  const tr = btn.closest('tr');

  const body = {
    id: tr.dataset.id,
    device_id: tr.querySelector('.device_id input').value,
    p_name: tr.querySelector('.p_name input').value,
    ph_no: tr.querySelector('.ph_no input').value,
    email: tr.querySelector('.email input').value,
    age: Number(tr.querySelector('.age input').value),
    checkin_date: tr.querySelector('.checkin_date input').value,
    checkout_date: tr.querySelector('.checkout_date input').value
  };

  const res = await fetch('/api/update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });

  if(!res.ok){
    const t = await res.text();
    console.error('Update error:', t);
    alert('Update failed');
    return;
  }

  loadPatients();
}

async function deletePatient(id){
  if(!confirm('Delete patient?')) return;
  await fetch('/api/infoDelete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id})
  });
  loadPatients();
}

loadPatients();
</script>

</body>
</html>
