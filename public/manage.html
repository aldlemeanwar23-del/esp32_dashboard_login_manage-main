<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Patients</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { background:#0a0f1a; color:#fff; font-family:Segoe UI; }
h2 { color:#00ffff; }
table { width:95%; margin:auto; border-collapse:collapse; }
th,td { border:1px solid #00ffff44; padding:8px; text-align:center; }
th { background:#001f2f; }

input {
  width:100%;
  padding:6px;
  background:#020617;
  color:#fff;
  border:1px solid #00ffff44;
  border-radius:5px;
}

button {
  padding:6px 10px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.add{background:#22c55e}
.edit{background:#0ea5e9}
.save{background:#16a34a}
.cancel{background:#f97316}
.delete{background:#ef4444}

.top-bar {
  width:95%;
  margin:15px auto;
  display:flex;
  justify-content:space-between;
}
.form {
  width:95%;
  margin:15px auto;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
  gap:10px;
}
</style>
</head>

<body>

<script>
if(localStorage.getItem('auth')!=='1') location.href='/login.html';
</script>

<div class="top-bar">
  <h2>üßæ Patient Management</h2>
  <button onclick="location.href='admin.html'">‚Üê Back</button>
</div>

<!-- ADD -->
<div class="form">
  <input id="device_id" placeholder="Device ID">
  <input id="p_name" placeholder="Patient Name">
  <input id="ph_no" placeholder="Mobile">
  <input id="email" placeholder="Email">
  <input id="age" placeholder="Age">
  <input id="checkin_date" type="date">
  <button class="add" onclick="addPatient()">‚ûï Add</button>
</div>

<table>
<thead>
<tr>
<th>ID</th><th>Device</th><th>Name</th><th>Mobile</th>
<th>Email</th><th>Age</th><th>CheckIn</th><th>CheckOut</th><th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
async function loadPatients(){
  const res = await fetch('/api/infoGet');
  const data = await res.json();
  const rows = document.getElementById('rows');
  rows.innerHTML='';

  data.forEach(r=>{
    rows.innerHTML += `
<tr data-id="${r.id}">
<td>${r.id}</td>
<td class="device_id">${r.device_id}</td>
<td class="p_name">${r.p_name}</td>
<td class="ph_no">${r.ph_no}</td>
<td class="email">${r.email}</td>
<td class="age">${r.age}</td>
<td class="checkin_date">${r.checkin_date}</td>
<td class="checkout_date">${r.checkout_date||''}</td>
<td>
  <button class="edit" onclick="editRow(this)">Edit</button>
  <button class="delete" onclick="deletePatient(${r.id})">Delete</button>
</td>
</tr>`;
  });
}

/* INLINE EDIT */
function editRow(btn){
  const tr = btn.closest('tr');
  ['device_id','p_name','ph_no','email','age','checkin_date','checkout_date']
  .forEach(c=>{
    const td = tr.querySelector('.'+c);
    td.innerHTML = `<input value="${td.innerText}">`;
  });

  tr.lastElementChild.innerHTML = `
    <button class="save" onclick="saveRow(this)">Save</button>
    <button class="cancel" onclick="loadPatients()">Cancel</button>
  `;
}

async function saveRow(btn){
  const tr = btn.closest('tr');

  const body = {
    device_id: tr.querySelector('.device_id input').value,
    pname: tr.querySelector('.p_name input').value,
    pmobile: tr.querySelector('.ph_no input').value,
    email: tr.querySelector('.email input').value,
    age: Number(tr.querySelector('.age input').value),
    chin: tr.querySelector('.checkin_date input').value,
    chout: tr.querySelector('.checkout_date input').value
  };

  await fetch('/api/update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });

  loadPatients();
}


/* ADD */
async function addPatient(){
  const body = {
    device_id: device_id.value,
    p_name: p_name.value,
    ph_no: ph_no.value,
    email: email.value,
    age: age.value,
    checkin_date: checkin_date.value
  };

  if(!body.device_id || !body.p_name){
    alert('Device ID & Patient Name required');
    return;
  }

  await fetch('/api/add',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });

  document.querySelectorAll('.form input').forEach(i=>i.value='');
  loadPatients();
}

/* DELETE */
async function deletePatient(id){
  if(!confirm('Delete patient?')) return;

  await fetch('/api/infoDelete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({id})
  });

  loadPatients();
}

loadPatients();
</script>

</body>
</html>
