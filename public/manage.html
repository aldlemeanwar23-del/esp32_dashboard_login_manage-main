<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage Patients</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background:#0a0f1a;
  color:#fff;
  font-family:Segoe UI;
}
h2 { text-align:center; color:#00ffff; margin:15px 0; }

table {
  width:95%;
  margin:auto;
  border-collapse:collapse;
}
th,td {
  border:1px solid #00ffff44;
  padding:6px;
  text-align:center;
}
th { background:#001f2f; }

input {
  background:#020617;
  color:#fff;
  border:1px solid #00ffff44;
  border-radius:5px;
  padding:4px;
  width:100%;
}

button {
  padding:6px 10px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  font-weight:bold;
}
.save { background:#22c55e; }
.delete { background:#ef4444; color:#fff; }

.form {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
  width:95%;
  margin:15px auto;
}

.top-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  width:95%;
  margin:auto;
}
.top-bar button { background:#00ffff; }
</style>
</head>

<body>

<script>
if(localStorage.getItem('auth')!=='1') location.href='/login.html';
</script>

<div class="top-bar">
  <h2>üßæ Patient Management</h2>
  <button onclick="location.href='admin.html'">‚Üê Back</button>
</div>

<!-- ADD PATIENT -->
<div class="form">
  <input id="device_id" placeholder="Device ID">
  <input id="pname" placeholder="Patient Name">
  <input id="pmobile" placeholder="Mobile">
  <input id="email" placeholder="Email">
  <input id="age" placeholder="Age">
  <input id="chin" type="date">
  <button onclick="addPatient()">Add Patient</button>
</div>

<table>
<thead>
<tr>
<th>ID</th>
<th>Device</th>
<th>Patient</th>
<th>Mobile</th>
<th>Email</th>
<th>Age</th>
<th>CheckIn</th>
<th>CheckOut</th>
<th>Action</th>
</tr>
</thead>
<tbody id="rows"></tbody>
</table>

<script>
function dateOnly(v){
  return v ? v.split('T')[0] : '';
}

async function loadPatients(){
  const res = await fetch('/api/infoGet');
  const data = await res.json();
  const tbody = document.getElementById('rows');
  tbody.innerHTML = '';

  data.forEach(r=>{
    tbody.innerHTML += `
<tr id="row-${r.id}">
<td>${r.id}</td>
<td><input class="device_id" value="${r.device_id}"></td>
<td><input class="pname" value="${r.p_name}"></td>
<td><input class="pmobile" value="${r.ph_no}"></td>
<td><input class="email" value="${r.email}"></td>
<td><input class="age" value="${r.age}"></td>
<td><input type="date" class="chin" value="${dateOnly(r.checkin_date)}"></td>
<td><input type="date" class="chout" value="${dateOnly(r.checkout_date)}"></td>
<td>
  <button class="save" onclick="saveRow(${r.id})">üíæ</button>
  <button class="delete" onclick="deletePatient(${r.id})">üóë</button>
</td>
</tr>`;
  });
}

async function saveRow(id){
  const row = document.getElementById(`row-${id}`);

  const body = {
    device_id: row.querySelector('.device_id').value,
    pname: row.querySelector('.pname').value,
    pmobile: row.querySelector('.pmobile').value,
    email: row.querySelector('.email').value,
    age: Number(row.querySelector('.age').value),
    chin: row.querySelector('.chin').value || null,
    chout: row.querySelector('.chout').value || null
  };

  try {
    const res = await fetch('/api/update',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(body)
    });

    if(!res.ok) throw await res.json();
    loadPatients();
  } catch(err){
    console.error(err);
    alert('Update failed');
  }
}

async function addPatient(){
  const body = {
    device_id: device_id.value,
    pname: pname.value,
    pmobile: pmobile.value,
    email: email.value,
    age: Number(age.value),
    chin: chin.value
  };

  if(!body.device_id || !body.pname){
    alert('Device ID & Patient Name required');
    return;
  }

  await fetch('/api/add',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(body)
  });

  device_id.value=pname.value=pmobile.value=email.value=age.value=chin.value='';
  loadPatients();
}

async function deletePatient(id){
  if(!confirm('Delete patient?')) return;
  await fetch('/api/infoDelete',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({id})
  });
  loadPatients();
}

loadPatients();
</script>

</body>
</html>
