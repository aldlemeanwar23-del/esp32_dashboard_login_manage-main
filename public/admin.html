<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0c111b;
  --card:#020617;
  --border:rgba(255,255,255,.15);
  --primary:#00ffff;
  --connected:#22c55e;
  --available:#64748b;
}

body{
  margin:0;
  font-family:'Segoe UI',Arial;
  background:var(--bg);
  color:#fff;
}

header{
  padding:15px 20px;
  background:#001f2f;
  color:var(--primary);
  font-size:22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.container{
  padding:20px;
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:15px;
}

/* Device Card */
.device-card{
  background:var(--card);
  border-radius:14px;
  padding:15px;
  border:2px solid var(--available);
  transition:.3s;
}

.device-card.connected{
  border-color:var(--connected);
  box-shadow:0 0 15px rgba(34,197,94,.4);
}

.device-card h3{
  color:var(--primary);
  margin-bottom:10px;
}

.status{
  font-weight:bold;
  margin-bottom:10px;
}

.status.connected{ color:var(--connected); }
.status.available{ color:#94a3b8; }

.card-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.card-actions button{
  flex:1;
  padding:8px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}

.add-btn{ background:#0ea5e9; color:#020617; }
.details-btn{ background:#00ffff; color:#020617; }

/* ===== MODAL ===== */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:1000;
}

.modal.show{ display:flex; }

.modal-box{
  width:320px;
  background:#020617;
  border-radius:14px;
  padding:20px;
  border:1px solid var(--border);
}

.modal-box h3{
  text-align:center;
  color:var(--primary);
  margin-bottom:10px;
}

.modal-box input{
  width:100%;
  margin:6px 0;
  padding:8px;
  border-radius:6px;
  border:1px solid var(--border);
  background:#0c111b;
  color:#fff;
}

.modal-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.modal-actions button{
  flex:1;
  padding:8px;
  border:none;
  border-radius:6px;
  font-weight:bold;
  cursor:pointer;
}
.save{ background:#22c55e; }
.cancel{ background:#ef4444; color:#fff; }
</style>
</head>

<body>

<script>
if(localStorage.getItem('auth')!=='1') location.href='/login.html';
</script>

<header>
  <span>ðŸ“Š Admin Dashboard</span>
  <button onclick="location.href='manage.html'">Patients</button>
</header>

<div class="container" id="devices"></div>

<!-- ===== MODAL ===== -->
<div id="addModal" class="modal">
  <div class="modal-box">
    <h3>Add Patient</h3>

    <input id="m_device" disabled>
    <input id="m_name" placeholder="Patient Name">
    <input id="m_mobile" placeholder="Mobile">
    <input id="m_email" placeholder="Email">
    <input id="m_age" placeholder="Age">
    <input id="m_chin" type="date">

    <div class="modal-actions">
      <button class="save" onclick="savePatient()">Save</button>
      <button class="cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
let currentDevice='';

/* Load Devices */
async function loadDevices(){
  const res = await fetch('/api/devices');
  const devices = await res.json();
  const box = document.getElementById('devices');
  box.innerHTML='';

  devices.forEach(d=>{
    const connected = d.connected;
    box.innerHTML+=`
      <div class="device-card ${connected?'connected':''}">
        <h3>${d.device_id}</h3>
        <div class="status ${connected?'connected':'available'}">
          ${connected?'Connected':'Device Available'}
        </div>

        <div class="card-actions">
          ${
            connected
            ? `<button class="details-btn" onclick="location.href='device.html?device=${d.device_id}'">Details</button>`
            : `<button class="add-btn" onclick="openModal('${d.device_id}')">âž• Add Patient</button>`
          }
        </div>
      </div>
    `;
  });
}

/* Modal Logic */
function openModal(device){
  currentDevice=device;
  m_device.value=device;
  m_name.value=m_mobile.value=m_email.value=m_age.value=m_chin.value='';
  addModal.classList.add('show');
}

function closeModal(){
  addModal.classList.remove('show');
}

async function savePatient(){
  if(!m_name.value){
    alert('Patient Name required');
    return;
  }

  await fetch('/api/add',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      device_id: currentDevice,
      pname: m_name.value,
      pmobile: m_mobile.value,
      email: m_email.value,
      age: Number(m_age.value),
      chin: m_chin.value
    })
  });

  closeModal();
  loadDevices();
}

loadDevices();
setInterval(loadDevices,3000);
</script>

</body>
</html>
