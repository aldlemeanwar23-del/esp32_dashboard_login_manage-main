<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family:Segoe UI;
  background:#0a0f1a;
  color:#fff;
}
header {
  padding:15px 25px;
  background:#001f2f;
  color:#00ffff;
  font-size:20px;
}
.devices {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:20px;
  padding:20px;
}
.card {
  background:rgba(0,255,255,0.08);
  border-radius:14px;
  padding:15px;
  cursor:pointer;
  transition:.2s;
}
.card:hover {
  transform:scale(1.02);
}
.card.disabled {
  cursor:default;
  opacity:.6;
}
.title {
  font-size:18px;
  margin-bottom:10px;
}
.values {
  display:flex;
  justify-content:space-around;
  margin-bottom:10px;
}
.value {
  text-align:center;
}
.status {
  text-align:center;
  color:#aaa;
  font-size:16px;
  display:none;
}
canvas {
  width:100%;
  height:80px !important;
}
</style>
</head>

<body>

<header>Admin Dashboard</header>

<div class="devices" id="devices"></div>

<script>
const DEVICE_LIST = ['max1','max2','max3'];
const charts = {};
const TIMEOUT = 10000; // 10 ثواني

const container = document.getElementById('devices');

/* إنشاء البطاقات */
DEVICE_LIST.forEach(d=>{
  const card = document.createElement('div');
  card.className = 'card disabled';
  card.id = `card-${d}`;
  card.onclick = ()=>openDevice(d);

  card.innerHTML = `
    <div class="title">${d.toUpperCase()}</div>

    <div class="values" id="${d}-values">
      <div class="value">
        <div id="${d}-hr">--</div>
        <small>HR</small>
      </div>
      <div class="value">
        <div id="${d}-spo">--</div>
        <small>SpO₂</small>
      </div>
    </div>

    <div class="status" id="${d}-status">الجهاز متاح</div>

    <canvas id="${d}-hrChart"></canvas>
    <canvas id="${d}-spoChart"></canvas>
  `;
  container.appendChild(card);

  charts[d] = {
    hr:new Chart(document.getElementById(`${d}-hrChart`),{
      type:'line',
      data:{labels:[],datasets:[{data:[],borderColor:'#00ffff'}]},
      options:{animation:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}
    }),
    spo:new Chart(document.getElementById(`${d}-spoChart`),{
      type:'line',
      data:{labels:[],datasets:[{data:[],borderColor:'#ff00ff'}]},
      options:{animation:false,plugins:{legend:{display:false}},scales:{x:{display:false},y:{display:false}}}
    })
  };
});

/* تحميل بيانات الجهاز */
async function loadDevice(device){
  try{
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    if(!Array.isArray(data) || data.length===0){
      setAvailable(device);
      return;
    }

    const last = data[data.length-1];
    const lastTime = new Date(last.time).getTime();

    if(Date.now() - lastTime > TIMEOUT){
      setAvailable(device);
      return;
    }

    setActive(device,last);

  }catch{
    setAvailable(device);
  }
}

/* الجهاز متصل */
function setActive(device,last){
  document.getElementById(`card-${device}`).classList.remove('disabled');
  document.getElementById(`${device}-status`).style.display='none';
  document.getElementById(`${device}-values`).style.display='flex';

  document.getElementById(`${device}-hr`).innerText = last.heartrate;
  document.getElementById(`${device}-spo`).innerText = last.spo2;

  charts[device].hr.data.labels=[''];
  charts[device].hr.data.datasets[0].data=[last.heartrate];
  charts[device].hr.update();

  charts[device].spo.data.labels=[''];
  charts[device].spo.data.datasets[0].data=[last.spo2];
  charts[device].spo.update();
}

/* الجهاز متاح (فصل) */
function setAvailable(device){
  document.getElementById(`card-${device}`).classList.add('disabled');

  document.getElementById(`${device}-values`).style.display='none';
  document.getElementById(`${device}-status`).style.display='block';

  charts[device].hr.data.labels=[];
  charts[device].hr.data.datasets[0].data=[];
  charts[device].hr.update();

  charts[device].spo.data.labels=[];
  charts[device].spo.data.datasets[0].data=[];
  charts[device].spo.update();
}

/* فتح صفحة الجهاز */
function openDevice(device){
  const card = document.getElementById(`card-${device}`);
  if(card.classList.contains('disabled')) return;
  window.location.href = `device.html?device=${device}`;
}

/* تحديث دوري */
DEVICE_LIST.forEach(loadDevice);
setInterval(()=>DEVICE_LIST.forEach(loadDevice),2000);
</script>

</body>
</html>
