<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Health Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  margin:0;
  font-family:Segoe UI, Arial;
  background:#0a0f1a;
  color:#fff;
}
.top-bar {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:18px 30px;
  background:rgba(2,6,23,.8);
  backdrop-filter:blur(10px);
  border-bottom:1px solid rgba(255,255,255,.15);
}
.top-bar h2 {
  margin:0;
  font-weight:600;
  color:#0ea5e9;
}
.top-bar .actions button {
  margin-left:10px;
  padding:10px 18px;
  background:#0ea5e9;
  color:#fff;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}
.top-bar .actions button:hover { opacity:.85; }

.container {
  width:95%;
  margin:20px auto;
}

table {
  width:100%;
  border-collapse:collapse;
}
th,td {
  border:1px solid rgba(255,255,255,.15);
  padding:10px;
  text-align:center;
}
th { background:#001f2f; color:#0ea5e9; }
td { background:rgba(255,255,255,.08); }

canvas {
  width:100px;
  height:50px;
}
</style>
</head>
<body>

<div class="top-bar">
  <h2>ü©∫ Admin Health Dashboard</h2>
  <div class="actions">
    <button onclick="location.href='archive.html'">Archive</button>
    <button onclick="location.href='manage.html'">Patients</button>
    <button onclick="logout()">Logout</button>
  </div>
</div>

<div class="container">
  <table>
    <thead>
      <tr>
        <th>Device</th>
        <th>Heart Rate</th>
        <th>SpO‚ÇÇ</th>
        <th>Chart</th>
      </tr>
    </thead>
    <tbody id="deviceRows"></tbody>
  </table>
</div>

<script>
function logout() {
  localStorage.removeItem('auth');
  location.href='/login.html';
}

const devices = ['max1','max2','max3','max4'];
const charts = {};

async function loadDevice(device) {
  const tbody = document.getElementById('deviceRows');
  try {
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    let lastHR = 'ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÖÿ™ÿßÿ≠';
    let lastSpO2 = 'ÿßŸÑÿ¨Ÿáÿßÿ≤ ŸÖÿ™ÿßÿ≠';

    if (data && data.length > 0) {
      const last = data[data.length-1];
      lastHR = last.heartrate + ' BPM';
      lastSpO2 = last.spo2 + ' %';
    }

    // ÿ•ŸÜÿ¥ÿßÿ° ÿµŸÅ ÿßŸÑÿ¨Ÿáÿßÿ≤ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØ
    if (!document.getElementById(device+'-row')) {
      const row = document.createElement('tr');
      row.id = device+'-row';
      row.innerHTML = `
        <td>${device.toUpperCase()}</td>
        <td id="${device}-hr">${lastHR}</td>
        <td id="${device}-spo">${lastSpO2}</td>
        <td><canvas id="${device}-chart"></canvas></td>
      `;
      tbody.appendChild(row);

      charts[device] = new Chart(document.getElementById(`${device}-chart`), {
        type:'line',
        data:{labels:[], datasets:[{label:'HR/SpO‚ÇÇ', data:[], borderColor:'#0ea5e9', fill:false}]},
        options:{responsive:true, animation:false, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
      });
    } else {
      document.getElementById(`${device}-hr`).innerText = lastHR;
      document.getElementById(`${device}-spo`).innerText = lastSpO2;
    }

    if (data && data.length > 0) {
      const chart = charts[device];
      chart.data.labels = data.map(()=> '');
      chart.data.datasets[0].data = data.map(r => r.heartrate);
      chart.update();
    }
  } catch(e) {
    console.error('Error loading device', device, e);
  }
}

function loadAllDevices() {
  devices.forEach(loadDevice);
}

loadAllDevices();
setInterval(loadAllDevices, 2000);
</script>

</body>
</html>
