<script>
/* =======================
   Auth check
   ======================= */
if (localStorage.getItem('auth') !== '1') {
  location.href = '/login.html';
}

/* =======================
   Get device (max1..max4)
   ======================= */
const params = new URLSearchParams(window.location.search);
let device = params.get('sensor'); // expected: max1..max4

if (!['max1','max2','max3','max4'].includes(device)) {
  device = 'max1'; // fallback safe
}

document.getElementById('sensorNo').innerText = device.toUpperCase();

/* =======================
   Chart setup
   ======================= */
let labels = [], hrData = [], spoData = [];

const hrChart = new Chart(document.getElementById('hrChart'), {
  type: 'line',
  data: {
    labels,
    datasets: [{
      label: 'Heart Rate',
      data: hrData,
      borderColor: '#00ffff',
      fill: true
    }]
  }
});

const spoChart = new Chart(document.getElementById('spoChart'), {
  type: 'line',
  data: {
    labels,
    datasets: [{
      label: 'SpOâ‚‚',
      data: spoData,
      borderColor: '#ff00ff',
      fill: true
    }]
  }
});

/* =======================
   Load data
   ======================= */
async function loadData() {
  try {
    const res = await fetch(`/api/sensor?device=${device}`);
    const data = await res.json();

    if (!Array.isArray(data) || !data.length) return;

    labels.length = hrData.length = spoData.length = 0;

    data.slice(-100).forEach(r => {
      labels.push('');
      hrData.push(r.heartrate);
      spoData.push(r.spo2);
    });

    const last = data[data.length - 1];
    document.getElementById('hr').innerText = last.heartrate + ' BPM';
    document.getElementById('spo').innerText = last.spo2 + ' %';

    hrChart.update();
    spoChart.update();
  } catch (err) {
    console.error('Sensor fetch error:', err);
  }
}

/* =======================
   Auto refresh
   ======================= */
setInterval(loadData, 2000);
loadData();
</script>
